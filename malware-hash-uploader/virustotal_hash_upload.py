import requests
from dotenv import load_dotenv
import os

load_dotenv()


# Replace with your actual VirusTotal API key
VIRUSTOTAL_API_KEY = os.getenv("VIRUSTOTAL_API_KEY")

def check_virustotal(file_hash):
    url = f"https://www.virustotal.com/api/v3/files/{file_hash}"
    headers = {"x-apikey": VIRUSTOTAL_API_KEY}
    response = requests.get(url, headers=headers)
    
    if response.status_code == 200:
        data = response.json()["data"]["attributes"]
        stats = data["last_analysis_stats"]
        positives = stats["malicious"] + stats["suspicious"]
        print("Positives:", positives)
        print("Stats:", stats)
        
        # Print detection engines and their results
        analysis_results = data.get("last_analysis_results", {})
        print("\nDetection Engines and their results:")
        for engine, result in analysis_results.items():
            print(f"Engine: {engine}")
            print(f"  Category: {result['category']}")
            print(f"  Result: {result['result']}")
            print(f"  Method: {result['method']}")
            print("-" * 30)
        return positives, stats
    elif response.status_code == 404:
        print("Hash not found in VirusTotal.")
        return "Hash not found in VirusTotal.", None
    else:
        error_message = f"Error: {response.status_code} - {response.text}"
        print(error_message)
        return error_message, None

# Call the function and print its result
# result = check_virustotal('2519a40199a2e619a585503eee7975c123800a7ee6011834bce8026fd18b8c69')
# print("Result from VirusTotal API:", result)